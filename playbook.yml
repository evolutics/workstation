- name: Do system-wide setup
  hosts: localhost
  tasks:
    - name: Update repositories cache
      become: true
      ansible.builtin.apt:
        update_cache: true

    - name: Remove packages
      become: true
      ansible.builtin.package:
        name:
          - mousepad
          - numlockx # Remove due to possible issue with Neo 2 keyboard layout.
        state: absent

    - name: Install packages
      become: true
      ansible.builtin.package:
        name:
          - anacron
          - containernetworking-plugins # For Podman.
          - golang-github-containernetworking-plugin-dnsname # For Podman.
          - libclang-dev
          - python3-venv
          - rsnapshot
          - steam
          - uidmap # For Podman.
          - usb-creator-gtk
          - variety
          - virtualbox

    - name: Configure keyboard layouts
      become: true
      ansible.builtin.lineinfile:
        line: "{{ item.line }}"
        path: /etc/default/keyboard
        regexp: "{{ item.regexp }}"
      loop:
        - line: 'XKBLAYOUT="de,us"'
          regexp: "^XKBLAYOUT="
        - line: 'XKBVARIANT="neo,"'
          regexp: "^XKBVARIANT="

    - name: Configure Firefox
      become: true
      ansible.builtin.copy:
        dest: /etc/firefox
        mode: preserve
        src: firefox/policies

    - name: Configure rsnapshot
      become: true
      ansible.builtin.template:
        dest: /etc/rsnapshot.conf
        mode: preserve
        src: rsnapshot.conf

    - name: Configure Anacron jobs
      become: true
      ansible.builtin.copy:
        dest: "/etc/{{ item }}"
        mode: preserve
        src: "{{ item }}.sh"
      loop:
        - cron.daily/back_up
        - cron.monthly/back_up
        - cron.weekly/back_up

    - name: Update all present packages
      become: true
      ansible.builtin.apt:
        upgrade: full

    - name: Clean up packages
      become: true
      ansible.builtin.apt:
        autoclean: true
        autoremove: true
